<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <title>JustCompress</title>
  </head>
  <body>
    <form id="upload-form">
        <s></s>
        <h1>Just<span style="color: #0000ffb3;">Compress</span></h1>
        <h2 style="text-align: center;">Tired of limited image compressors? Don't worry, I've got your back.<br>
        Free open source image compressor</h2>
        <input type="file" id="file" name="files" accept="image/*" multiple style="display: none;" />
        <div class="drop-zone" id="drop-zone">
            Drag & Drop your images here or click to select.
        </div>
        <label for="compression">Select compression type:</label>
        <select id="compression" name="compression">
            <option value="webp">WEBP</option>
            <option value="jpeg">JPEG</option>
            <option value="png">PNG</option>
        </select>
        <span>
          <button type="submit">Submit</button>
          <button type="reset" id="resetButton">Reset</button>
        </span>
    </form>

    <script>
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file');
      const form = document.getElementById('upload-form');
      const resetButton = document.getElementById('resetButton');
      let droppedFiles = [];

      dropZone.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files);
      });

      dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
      });

      resetButton.addEventListener('click', () => {
          dropZone.innerHTML = 'Drag & Drop your images here or click to select';
          droppedFiles = [];
      });

      function handleFiles(files) {
          dropZone.innerHTML = '';
          droppedFiles = files;
          Array.from(files).forEach(file => {
              if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      const img = document.createElement('img');
                      img.src = e.target.result;
                      dropZone.appendChild(img);
                  };
                  reader.readAsDataURL(file);
              } else {
                  alert('Please upload a valid image file.');
              }
          });
      }

      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const files = droppedFiles.length ? droppedFiles : fileInput.files;
          const compressionType = document.getElementById('compression').value;
          const compressedFiles = await compressImages(files, compressionType);
          downloadCompressedFiles(compressedFiles);
      });

      async function compressImages(files, compressionType) {
          const compressedFiles = [];
          for (const file of files) {
              const compressedFile = await compressImage(file, compressionType);
              compressedFiles.push(compressedFile);
          }
          return compressedFiles;
      }

      function compressImage(file, compressionType) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                  const img = new Image();
                  img.onload = () => {
                      const canvas = document.createElement('canvas');
                      const ctx = canvas.getContext('2d');
                      canvas.width = img.width;
                      canvas.height = img.height;
                      ctx.drawImage(img, 0, 0);
                      canvas.toBlob((blob) => {
                          const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, `.${compressionType}`), {
                              type: `image/${compressionType}`
                          });
                          resolve(compressedFile);
                      }, `image/${compressionType}`);
                  };
                  img.src = e.target.result;
              };
              reader.readAsDataURL(file);
          });
      }

      async function downloadCompressedFiles(files) {
          const zip = new JSZip();
          const imgFolder = zip.folder("images");
          if (!files.length) {
              alert('No files to download.');
              return;
          }
          for (const file of files) {
              const arrayBuffer = await file.arrayBuffer();
              imgFolder.file(file.name, arrayBuffer);
          }

          zip.generateAsync({ type: "blob" }).then((content) => {
              const url = window.URL.createObjectURL(content);
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = url;
              a.download = 'compressed_images.zip';
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
          });
      }
    </script>
  </body>
</html>